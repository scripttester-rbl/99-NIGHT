-- ===================================================================
-- SERVIÇOS E VARIÁVEIS GLOBAIS
-- ===================================================================
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage") -- [LÓGICA ONLINE] Precisamos acessar os RemoteEvents
local TeleportService = game:GetService("TeleportService")

local player = Players.LocalPlayer

local character
local humanoidRootPart

-- !! IMPORTANTE !! O nome do baú continua sendo necessário
local CHEST_NAME = "DiamondChest" 
-- !! MUDANÇA CRÍTICA !! Você PRECISA encontrar o nome do RemoteEvent que o jogo usa para coletar itens.
-- Este é um palpite. O nome real provavelmente é diferente.
local REMOTE_EVENT_NAME = "CollectChestEvent" -- Exemplo: pode ser "Claim", "Interact", "ChestRequest", etc.

local scriptEnabled = false
local isBusy = false -- Renomeado de "isTeleporting" para refletir a nova lógica

-- ===================================================================
-- GUI (Sem alterações)
-- ===================================================================
local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
screenGui.ResetOnSpawn = false
local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0, 200, 0, 50)
mainFrame.Position = UDim2.new(0.5, -100, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BorderSizePixel = 0
local toggleButton = Instance.new("TextButton", mainFrame)
toggleButton.Size = UDim2.new(1, 0, 1, 0)
toggleButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
toggleButton.Text = "Auto-Farm: OFF"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.TextSize = 18
toggleButton.MouseButton1Click:Connect(function()
    scriptEnabled = not scriptEnabled
    isBusy = false
    if scriptEnabled then
        toggleButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        toggleButton.Text = "Auto-Farm: ON"
        print("Script ativado!")
    else
        toggleButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        toggleButton.Text = "Auto-Farm: OFF"
        print("Script desativado.")
    end
end)

-- ===================================================================
-- FUNÇÕES PRINCIPAIS (ADAPTADAS PARA ONLINE)
-- ===================================================================

-- Esta função continua igual, pois o cliente pode ler o Workspace
function findNearestChest()
    local nearestChest = nil
    local minDistance = math.huge
    if not humanoidRootPart then return nil end
    for _, v in ipairs(Workspace:GetDescendants()) do
        if v.Name == CHEST_NAME and (v:IsA("BasePart") or v:IsA("Model")) then
            local partPosition
            if v:IsA("Model") and v.PrimaryPart then
                partPosition = v.PrimaryPart.Position
            elseif v:IsA("BasePart") then
                partPosition = v.Position
            else
                continue
            end
            local distance = (humanoidRootPart.Position - partPosition).Magnitude
            if distance < minDistance then
                minDistance = distance
                nearestChest = v
            end
        end
    end
    return nearestChest
end

-- [MUDANÇA CRÍTICA] A função de coleta agora dispara um RemoteEvent
function collectChestRemotely(chest)
    -- Encontra o RemoteEvent dentro do ReplicatedStorage
    local remoteEvent = ReplicatedStorage:FindFirstChild(REMOTE_EVENT_NAME, true) -- O 'true' busca em todos os descendentes

    if remoteEvent then
        print("RemoteEvent '" .. REMOTE_EVENT_NAME .. "' encontrado! Disparando para o servidor...")
        -- Dispara o evento, enviando o baú como argumento.
        -- O servidor vai receber este "pedido" de coleta.
        remoteEvent:FireServer(chest)
    else
        print("ERRO: Não foi possível encontrar o RemoteEvent chamado '" .. REMOTE_EVENT_NAME .. "'. A coleta falhará.")
    end
end

-- [LÓGICA ONLINE] Esta função agora funciona como esperado em servidores públicos
function serverHop()
    print("Coleta solicitada. Mudando de servidor...")
    pcall(function()
        -- Simplesmente se teleporta para o mesmo jogo, o Roblox te colocará em um servidor diferente
        TeleportService:Teleport(game.PlaceId)
    end)
end

-- ===================================================================
-- LOOP PRINCIPAL
-- ===================================================================
while true do
    task.wait(1)
    
    character = player.Character
    humanoidRootPart = character and character:FindFirstChild("HumanoidRootPart")

    if scriptEnabled and not isBusy and humanoidRootPart then
        local chest = findNearestChest()
        
        if chest then
            isBusy = true -- Impede o script de rodar de novo
            
            print("Baú encontrado:", chest.Name)
            
            -- [MUDANÇA CRÍTICA] Em vez de teleportar, nós pedimos a coleta remotamente
            collectChestRemotely(chest)
            
            -- Espera um pouco para o pedido ser processado antes de pular de servidor
            wait(1) 
            
            serverHop()

            -- Se o teleporte falhar, o script vai destravar após 5 segundos
            wait(5)
            isBusy = false
        else
            print("Procurando por baús de diamante...")
        end
    end
end
